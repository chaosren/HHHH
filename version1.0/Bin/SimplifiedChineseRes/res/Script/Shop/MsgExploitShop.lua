---------------------------------------------------
--描述: 军功商城
--时间: 2013.7.31
--作者: qbw
---------------------------------------------------
MsgExploitShop = {}
local p = MsgExploitShop;


--购买物品
function p.SendExtrangeExploit(nId,nNum)
	local netdata = createNDTransData(NMSG_Type._MSG_EXPLOITSHOP);
	if nil == netdata then
		return false;
	end
	netdata:WriteByte(2);	
	netdata:WriteInt(nId);	
	netdata:WriteInt(nNum);	
	
	SendMsg(netdata);
	netdata:Free();
	LogInfo("qboy  SendExtrangeExploit nId:"..nId.." nNum:"..nNum);
	ShowLoadBar();
	return true;
end


function p.ProcessExPloit(netdata)
	local nAction  = netdata:ReadByte();
	LogInfo("qboy  ProcessExPloit nAction:"..nAction);
					
	if nAction ==1 then
		local ncount = netdata:ReadInt();
		LogInfo("qboy  ProcessExPloit ncount:"..ncount);
	
		for i= 1 , ncount do
			local id = netdata:ReadInt();
			local buynum = netdata:ReadInt();
			LogInfo("qboy  ProcessExPloit id:"..id.." buynum:"..buynum);
			--更新数据
			for j,v in pairs(ExploitShop.GoodsShowId) do
				if v.ID == id then
					LogInfo("qboy  ProcessExPloit nId:"..id.." v.BUYNUMLEFT:"..v.BUYNUMLEFT);
					v.BUYNUMLEFT = v.EXCHANGE_LIMIT - buynum;
				end
			end
			
			--刷新显示
			ExploitShop.SetGoodsInfo()
		end
		
		
	elseif nAction == 2 then
		--刷新
		ExploitShop.SendGetExploitInfo();

	end
	
	CloseLoadBar();
end




RegisterNetMsgHandler(NMSG_Type._MSG_EXPLOITSHOP, "p.ProcessExPloit", p.ProcessExPloit);



