-----------------------------------------------------描述: 斗地主网络消息处理及其逻辑--时间: 2012.12.24--作者: qbw---------------------------------------------------MsgSlave = {}local p = MsgSlave;SlaveActionType = {		ActionGetSyndicateSlave = 0,	--获取自己军团被捕的人员		ActionRevolt = 1,				--反抗		ActionCatch = 2,				--捕获		ActionGetTargetList = 3,		--获取可以捕获的目标列表		ActionHelp = 4,					--帮助解救		ActionSOS = 5,					--求救		ActionGetMainInfo = 6,			--获取该系统主信息		ActionGetEnemyList = 7,			--获取仇人列表		ActionActivity = 8,				--互动		ActionAddCatchCount = 9,		--金币增加捕获次数		ActionCompleteSlaveWork = 10,	--直接结束奴隶工作		ActionAddSOSCount = 11,			--增加求救次数		ActionAddRevoltCount = 12,		--增加反抗次数		ActionAddHelpCount = 13,			--增加解救次数		ActionAddActivityCount = 14,		--增加互动次数		ActionAddAttEnemyCount = 15,		--增加攻击仇人次数		ActionUpgradeSlave = 16,			--升级奴隶		ActionAttEnemy = 17,			--攻击仇人		ActionFreeSlave = 18,			--释放奴隶		ActionExtractCoin		=19, 			--提取银币 		ActionQuit		=20, 			--退出		ActionSosList = 21,--请求求救列表		ActionUseItemRet = 22,--使用物品返回}local StateType = {		ChaosBattleStateNotOpen = 0,	--未开启		ChaosBattleStatePrepare = 1,	--准备		ChaosBattleStateOpen = 2,	--开启		ChaosBattleStateClosing = 3,	--准备关闭		ChaosBattleStateComplete = 4,	--关闭}function p.SendAction(nType,nparam1,nparam2)	local netdata = createNDTransData(NMSG_Type._MSG_LANDLORDS_ACTION);	if nil == netdata then		return false;	end	netdata:WriteByte(nType);			if nparam1 ~= nil then		netdata:WriteInt(nparam1);			LogInfo("qboy  MsgSlave.SendAction nparam1 "..nparam1);	end		if nparam2 ~= nil then		netdata:WriteInt(nparam2);			LogInfo("qboy  MsgSlave.SendAction nparam2 "..nparam2);	end		SendMsg(netdata);	netdata:Free();	LogInfo("qboy  MsgSlave.SendAction");	ShowLoadBar();	return true;endtSlaveType = {	Free = 0,	Owner = 1,	Slave = 2,}function  p.ProcessPlayerInfo(netdata)	--qbw	Slave.ClearSlaveData();	local nUserId = netdata:ReadInt(); 	local nType = netdata:ReadByte();	local nCatchCount = netdata:ReadByte();	local nHelpCount = netdata:ReadByte();	local nRevoltCount = netdata:ReadByte();	local nActivityCount = netdata:ReadByte();	local nSosCount = netdata:ReadByte(); 		local nAttEnemyCount = netdata:ReadByte(); 		--已用金币购买次数	local nAddCatchCount = netdata:ReadByte(); 	local nAddHelpCount = netdata:ReadByte(); 	local nAddRevoltCount = netdata:ReadByte(); 	local nAddActivityCount = netdata:ReadByte(); 	local nAddSosCount = netdata:ReadByte(); 		local  nAddAttEnemyCount = netdata:ReadByte(); 			local nSlaveLevel1 = netdata:ReadByte();	local nSlaveLevel2 = netdata:ReadByte();	local nSlaveLevel3 = netdata:ReadByte();	LogInfo("nSlaveLevel:"..nSlaveLevel1.." "..nSlaveLevel2.." "..nSlaveLevel3)	local nStore = netdata:ReadInt(); --未提取	local nGained = netdata:ReadInt(); --所有已提取	local nMaxGain =  netdata:ReadInt(); 	--LogInfo("gtype:"..nType)	local nBawang =  netdata:ReadByte();	local nWuguiTime = netdata:ReadInt();			local nRevoltCD =  netdata:ReadInt();--反抗cd	local ActivityCD =  netdata:ReadInt(); --互动cd	LogInfo("nRevoltCD:"..nRevoltCD.." "..ActivityCD)	--LogInfo("nCatchCount:"..nCatchCount.." "..nGained.." "..nStore)		Slave.SetInfo(nType,nCatchCount,nHelpCount,nRevoltCount,nActivityCount,nSosCount ,nSlaveLevel1,nSlaveLevel2,nSlaveLevel3,nStore,nGained,nMaxGain,nBawang,nWuguiTime,nRevoltCD,ActivityCD );	Slave.SetPayCount(nAddCatchCount,nAddHelpCount,nAddRevoltCount,nAddActivityCount,nAddSosCount);		if tSlaveType.Owner == nType then		p.ProcessPlayerInfoOwner(netdata);		elseif tSlaveType.Slave == nType then		p.ProcessPlayerInfoSlave(netdata);		end			Slave.LoadUI();endfunction p.ProcessPlayerInfoOwner(netdata)	local nCount = netdata:ReadByte();	for i=1,13 do		netdata:ReadByte();	end			LogInfo("qboy  ProcessPlayerInfoOwner nCount"..nCount);	for i=1,nCount do 		local  nUserId = netdata:ReadInt();		--local  nStartTime = netdata:ReadInt();		local  nProid	= netdata:ReadInt();		local  nLevel	= netdata:ReadShort();				local  nLeftTime = netdata:ReadInt();		local  nSlot = netdata:ReadByte();		local  sName = netdata:ReadUnicodeString();			LogInfo("qboy  ProcessPlayerInfoOwner".." "..nUserId.." "..nLeftTime.." "..sName.." "..nProid.." "..nLevel);		Slave.SetSlaveInfo(nSlot,nUserId,nLeftTime,nProid,nLevel,sName);			endendfunction p.ProcessPlayerInfoSlave(netdata)	local  nOwnerId = netdata:ReadInt();	local  nLeftTime = netdata:ReadInt();	local  nProid	= netdata:ReadInt();	local  nLevel	= netdata:ReadShort();		local  sName = netdata:ReadUnicodeString();		LogInfo("qboy  ProcessPlayerInfoSlave".." "..nOwnerId.." "..nLeftTime.." "..sName.." "..nProid.." "..nLevel);	Slave.SetOwnerInfo(nOwnerId,nLeftTime,nProid,nLevel,sName)end--获取可捕获玩家信息并加载uifunction p.ProcessCatchList(netdata)	--Slave.ClearSlaveData()	local nCount = netdata:ReadShort();	local nFlag =  netdata:ReadByte();	if nFlag == 0 or nFlag == 3 then		Slave.ClearCatchData()	end	LogInfo("qboy  ProcessCatchList nCount"..nCount);	if nCount <= 0 then		CommonDlgNew.ShowYesDlg( GetTxtPri("DDZ_T57")); 	 		return;	end		for i = 1,nCount do		local nUserid = netdata:ReadInt();		local nProid = netdata:ReadInt();		local nlevel = netdata:ReadShort();			local nWuguiState = netdata:ReadByte();		local nType = netdata:ReadByte();		local sName = netdata:ReadUnicodeString();				local sLandlordName = ""		if nType == tSlaveType.Slave then			sLandlordName =  netdata:ReadUnicodeString();		end				LogInfo("qboy  ProcessCatchList "..nUserid.." "..nProid.." "..nlevel.." "..sName);		Slave.InsertCatchData(nUserid,nProid,nlevel,nWuguiState,sName,nType,sLandlordName);			end	if nFlag == 2 or nFlag == 3 then		Slave.LoadCatchUI();	endend--获取仇人玩家信息并加载uifunction p.ProcessEnemyList(netdata)	--Slave.ClearSlaveData()	local nCount = netdata:ReadShort();	local nFlag =  netdata:ReadByte();	if nFlag == 0 or nFlag == 3 then		Slave.ClearCatchData()	end		for i = 1,nCount do		local nUserid = netdata:ReadInt();		local nProid = netdata:ReadInt();		local nlevel = netdata:ReadShort();			local nWuguiState = netdata:ReadByte();		local nType = netdata:ReadByte();		local sName = netdata:ReadUnicodeString();				local sLandlordName = ""		if nType == tSlaveType.Slave then			sLandlordName =  netdata:ReadUnicodeString();		end						Slave.InsertCatchData(nUserid,nProid,nlevel,nWuguiState,sName,nType,sLandlordName);			end	if nFlag == 2 or nFlag == 3 then		Slave.LoadEnemyUI();	endend--获取军团被抓玩家信息并加载uifunction p.ProcessSynSlaveList(netdata)	--Slave.ClearSlaveData()	local nCount = netdata:ReadShort();	local nFlag =  netdata:ReadByte();	if nFlag == 0 or nFlag == 3 then		Slave.ClearSynslaveData()	end		for i = 1,nCount do		local nUserid = netdata:ReadInt();		local nProid = netdata:ReadInt();		local nlevel = netdata:ReadShort();			local nWuguiState = netdata:ReadByte();		local sName = netdata:ReadUnicodeString();		local sOwnerName = netdata:ReadUnicodeString();		LogInfo("qboy  ProcessSynSlaveList sOwnerName"..sOwnerName)				Slave.InsertSynslaveData(nUserid,nProid,nlevel,nWuguiState,sName,tSlaveType.Slave,sOwnerName);			end	if nFlag == 2 or nFlag == 3 then		Slave.LoadSynSlaveUI();	endendfunction p.ProcessActionRet(netdata)	CloseLoadBar();	local nAction = netdata:ReadByte();	local bIsSuccess = netdata:ReadByte();	--离开界面	if nAction == SlaveActionType.ActionQuit then		if bIsSuccess == 1 then			Slave.CloseUI();		end	end		endfunction p.ProcessNotify(netdata)	local sNotify = netdata:ReadUnicodeString();		LogInfo("qboy  ProcessNotify:"..sNotify);		Slave.SetNotify(sNotify);endfunction p.ProcessSosList(netdata)	local nCount  = netdata:ReadShort();	local nFlag =  netdata:ReadByte();	if nFlag == 0 or nFlag == 3 then		Slave.ClearSynSosData()	end			for i= 1,nCount do		local nUserId =  netdata:ReadInt();		local nLevel = netdata:ReadShort();		local nName = netdata:ReadUnicodeString();		LogInfo("qboy  ProcessSosList:"..nUserId.." "..nLevel.." "..nName);		--Slave.InsertCatchData(nUserid,nProid,nlevel,nWuguiState,sName,tSlaveType.Slave,sOwnerName);				Slave.InsertSosData(nUserId,nLevel,nName);					end	if nFlag == 2 or nFlag == 3 then		Slave.LoadUISynSos();	end	endRegisterNetMsgHandler(NMSG_Type._MSG_LANDLORDS_PLAYER_INFO, "p.ProcessPlayerInfo", p.ProcessPlayerInfo);RegisterNetMsgHandler(NMSG_Type._MSG_LANDLORDS_TARGET_LIST, "p.ProcessCatchList", p.ProcessCatchList);RegisterNetMsgHandler(NMSG_Type._MSG_LANDLORDS_ENEMY_LIST, "p.ProcessEnemyList", p.ProcessEnemyList);RegisterNetMsgHandler(NMSG_Type._MSG_LANDLORDS_SYNSLAVES, "p.ProcessSynSlaveList", p.ProcessSynSlaveList);RegisterNetMsgHandler(NMSG_Type._MSG_LANDLORDS_ACTION_RET, "p.ProcessActionRet", p.ProcessActionRet);RegisterNetMsgHandler(NMSG_Type._MSG_LANDLORDS_NOTIFY, "p.ProcessNotify", p.ProcessNotify);RegisterNetMsgHandler(NMSG_Type._MSG_LANDLORDS_SOS_LIST, "p.ProcessSosList", p.ProcessSosList);